<!DOCTYPE html>
<html class="no-js" lang="en-us" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
	<meta name="generator" content="Hugo 0.37.1" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Forget me not...">
    <meta name="author" content="">

    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/favicon.ico">

    <title>Forget me not... &middot; Forget me not...</title>

   	
    
        <link rel="stylesheet" href="https://henrich.github.io/blog//css/theme/simplex.css">
    

    <link rel="stylesheet" href="https://henrich.github.io/blog//css/font-awesome.min.css">

   	
   	<link rel="stylesheet" href="https://henrich.github.io/blog//css/style.css">


    
    <script src="https://henrich.github.io/blog//js/jquery.min-2.1.4.js"></script>
    <script src="https://henrich.github.io/blog//js/bootstrap.min-3.3.5.js"></script>

    
    <link href="https://henrich.github.io/blog/index.xml" rel="alternate" type="application/rss+xml" title="Forget me not..." />
</head>
<body lang="en">
    
    <div class="container">
    <div class="row">
        <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="https://henrich.github.io/blog/">Forget me not...</a>
            </div>
            <div class="navbar-collapse collapse navbar-responsive-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://henrich.github.io/blog/">Home</a></li>
                    <li><a href="https://henrich.github.io/blog//post/">Blog</a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</div>



    <div class="container">
        
        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/13/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Fri, Oct 13, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<p><code>gbpの使い方をざっと教えて</code> というリクエストを頂いたのでざっくりメモ。</p>

<hr />

<pre><code>$ git clone https://anonscm.debian.org/git/collab-maint/cutter-testing-framework.git
Cloning into 'cutter-testing-framework'...
remote: Counting objects: 3334, done.
remote: Compressing objects: 100% (949/949), done.
remote: Total 3334 (delta 2336), reused 3323 (delta 2336)
Receiving objects: 100% (3334/3334), 3.69 MiB | 442.00 KiB/s, done.
Resolving deltas: 100% (2336/2336), done.

$ cd cutter-testing-framework/

$ gbp import-orig --uscan --pristine-tar
gbp:error: 
Repository does not have branch 'upstream' for upstream sources. If there is none see
file:///usr/share/doc/git-buildpackage/manual-html/gbp.import.html#GBP.IMPORT.CONVERT
on howto create it otherwise use --upstream-branch to specify it.

$ git checkout upstream
Branch 'upstream' set up to track remote branch 'upstream' from 'origin'.
Switched to a new branch 'upstream'
$ git checkout pristine-tar 
Branch 'pristine-tar' set up to track remote branch 'pristine-tar' from 'origin'.
Switched to a new branch 'pristine-tar'
$ git checkout master 
Switched to branch 'master'
Your branch is up to date with 'origin/master'.

$ gbp import-orig --uscan --pristine-tar
gbp:info: Launching uscan...
uscan: Newest version of cutter-testing-framework on remote site is 1.2.6, local version is 1.2.4
uscan:    =&gt; Newer package available from
      http://cutter.sourceforge.net/archives/debian/cutter-testing-framework-1.2.6.tar.gz
gbp:info: using ../cutter-testing-framework_1.2.6.orig.tar.gz
What is the upstream version? [1.2.6] 
gbp:info: Importing '../cutter-testing-framework_1.2.6.orig.tar.gz' to branch 'upstream'...
gbp:info: Source package is cutter-testing-framework
gbp:info: Upstream version is 1.2.6
gbp:info: Replacing upstream source on 'master'
gbp:info: Successfully imported version 1.2.6 of ../cutter-testing-framework_1.2.6.orig.tar.gz
(色々編集してコミット...)
$ dch -v 1.2.6-1
$ dch -r
$ gbp buildpackage --git-pbuilder --git-pristine-tar
</code></pre>

<hr />

<ul>
<li>upstream archiveのimportの際に <code>--pristine-tar</code> でpristine-tarブランチにコミットしておくのを忘れない</li>
<li>最初にupstreamブランチとpristine-tarブランチをchekoutしないとビルドの際にエラー（面倒くさいけど）

<ul>
<li><code>--git-pbuilder</code> でpbuilder/cowbuilder環境を使う</li>
<li><code>--git-pristine-tar</code> で pristine-tar ブランチのファイルを使う</li>
</ul></li>
</ul>

<p>これぐらいかな。今回はmasterブランチが＝debian作業のブランチだけど、debianブランチを分けて作ってる場合は <code>--git-ignore-branch</code> 付けてビルドが必要。</p>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/11/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Wed, Oct 11, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li>DMの方の活動が年単位で無いのでping</li>
</ul>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/10/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Tue, Oct 10, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li><a href="https://anonscm.debian.org/git/collab-maint/cutter-testing-framework.git">cutter-testing-frameworkのリポジトリを作っておいた</a>

<ul>
<li>実作業はupstreamの@kenhysさんにお任せで</li>
</ul></li>
<li>とりあえず、unidicをアップデートしてみるか？と少しだけ作業。

<ul>
<li>他のunidic辞書もパッケージにしても面白いか？</li>
</ul></li>
<li><a href="https://oss-gate.github.io/">OSS Gate</a>に拙著を寄贈しようと言う話をした。</li>
<li>昨日のos-autoinstのハングアップが直ったのでその旨連絡した。</li>
<li>os-autoinstで<a href="https://github.com/os-autoinst/os-autoinst/pull/865">debhelperが誤ってファイルを消すのを対処</a>した。</li>
<li><a href="https://twitter.com/takuya_ono/status/917653702244044801">guacamoleパッケージがおかしい、というつぶやき</a>を見たので、MLにパッチの提案だけしておく</li>
</ul>

<hr />

<p>rustを使ったソースのパッケージングについて。</p>

<p><a href="https://github.com/sharkdp/fd">https://github.com/sharkdp/fd</a> というのを見かけて面白そうなのでパッケージングしてみようとする。</p>

<pre><code>$ git clone https://github.com/sharkdp/fd; cd fd
$ git checkout -b debian
$ dh_make --createorig -s -p fd_4.0.0
(debianディレクトリをいじる…)
$ git add debian; git commit
</code></pre>

<p>で、ビルドすると通るけど何もしてない風味。ざっくりrustcを使うのはなにかあるのだろうか？と調べると dh-cargo というのが見つかった。どうやら、rustなパッケージは <code>dh --buildsystem cargo</code> という形で実施するようだ。</p>

<pre><code>   dh_auto_install -O--buildsystem=cargo
cp: cannot stat './debian/cargo-checksum.json': No such file or directory
dh_auto_install: cp ./debian/cargo-checksum.json /build/fd-4.0.0/debian/cargo_registry/fd-4.0.0/.cargo-checksum.json returned exit code 1
</code></pre>

<p>debian/cargo-checksum.json が必要、らしいが <a href="https://wiki.debian.org/Teams/RustPackaging/Policy">https://wiki.debian.org/Teams/RustPackaging/Policy</a> を見ても何書いていいかがさっぱりわからん… <a href="https://codesearch.debian.net/search?q=debian%2Fcargo-checksum.json">ソースを検索した</a>けど、もとからあるファイルをコピーしているようにしか見えない（が、無いんだよな…）</p>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/09/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Mon, Oct 9, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li>os-autoinstが止まるのをinvestigation。

<ul>
<li>新しいperlモジュールがtestに必要になってたようなので、ビルドする。<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=878042">ITPもする</a>。<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=878041">そのビルドに必要な別のperlモジュールもITPする</a></li>
<li>ITPしたのは<a href="http://pkg-perl.alioth.debian.org/git.html">$ dtp alioth-repo</a>という感じでpushしておいた。</li>
<li>が、やっぱり止まるのは変わらないので<a href="https://progress.opensuse.org/issues/25844">issue登録</a>。</li>
<li>何が原因だか、今の所サッパリなので Jessie や Strech 環境を作ったりしてテスト。Jessie だと libmojolicious-perl が古すぎてモジュールが含まれないせいでテストコケるのでsidのを持ってきたり。その流れでnewest upstreamのを手元でビルドして差し替えもしてみた。が、結局何も変わらず。</li>
</ul></li>
<li>unidicのサイトが変更されたのに関する<a href="https://twitter.com/henrich/status/917274260153843712">ライセンス表記周りの意見</a>。</li>
<li>忘れてた<a href="https://github.com/sphinx-doc/sphinx/issues/4131">sphinxのissue登録</a>をやっておいた</li>
</ul>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/08/fedora-modularity-memo/">Fedora Modularity Memo</a></h3>
						<small><span class="label label-primary">
							
								Sun, Oct 8, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/fedora">fedora</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li><a href="https://communityblog.fedoraproject.org/factory-2-0-mean-modularity/">https://communityblog.fedoraproject.org/factory-2-0-mean-modularity/</a></li>
<li><a href="http://threebean.org/presentations/factory2-devconf17">The Productization Pipeline and the so-called &ldquo;Factory 2.0&rdquo;</a></li>
<li></li>
</ul>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/08/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Sun, Oct 8, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li>忘れないうちに<a href="https://github.com/os-autoinst/openQA/pull/1465">１行パッチ</a>をopenQAに。</li>
<li>openSUSE asia summitの発表の練習をしてみる。15分にはなんとか収まりそう。</li>
<li>Debian JPのサイト、9.2リリースを反映しておいた</li>
</ul>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/07/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Sat, Oct 7, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li><a href="https://www.debian.org/releases/stretch/amd64/release-notes/">リリースノート</a>の更新に気がついたので追従しておいた。</li>
<li>openSUSEをいじってたらsnapperのアップデートがあったが、<a href="https://github.com/openSUSE/snapper/issues/364">そのバージョンのタグがgit repositoryに打たれてない。。。</a></li>
<li>openQAやos-autoinstもタグが打たれてないので、<a href="https://progress.opensuse.org/issues/25826">お願いを出す</a>など&hellip;。</li>
</ul>

<hr />

<p>openQAを漸くビルドし始めたのだけど、早速モジュールが足りないというエラーが&hellip;</p>

<pre><code>Can't locate Mojolicious/Plugin/AssetPack/Backcompat.pm in @INC (you may need
        to install the Mojolicious::Plugin::AssetPack::Backcompat module)
</code></pre>

<p>なんでupstreamの依存関係には含まれとらんのだろう？</p>

<p>んじゃさくっとdh-make-perl&hellip;したらcpanに無い？？？どうやら消されているようだ。仕方がないので<a href="https://github.com/jhthorsen/mojolicious-plugin-assetpack/issues/129">upstreamに質問</a>
→ <a href="http://backpan.cpantesters.org/authors/id/J/JH/JHTHORSEN/">backpan</a>というところに消したのは置いてあるよ、と教えてもらった。しかし、<a href="http://backpan.cpantesters.org/authors/id/J/JH/JHTHORSEN/Mojolicious-Plugin-AssetPack-Backcompat-1.24.readme">本来これは必要ないはず</a>、なんだけども&hellip;？</p>

<p>兎にも角にも、とりあえずぶち込んでみてtestを実行してみると&hellip;またエラーだ。以下が延々と。</p>

<pre><code>Uncaught exception from user code:
        Plugin &quot;bootstrap3&quot; missing, maybe you need to install it?
        Mojolicious::Plugins::load_plugin(Mojolicious::Plugins=HASH(0x562086593f80), &quot;bootstrap3&quot;) called at /usr/share/perl5/Mojolicious/Plugins.pm line 46
        Mojolicious::Plugins::register_plugin(Mojolicious::Plugins=HASH(0x562086593f80), &quot;bootstrap3&quot;, OpenQA::WebAPI=HASH(0x562086540380), HASH(0x5620867fe6d8)) called at /usr/share/perl5/Mojolicious.pm line 186
        Mojolicious::plugin(OpenQA::WebAPI=HASH(0x562086540380), &quot;bootstrap3&quot;, HASH(0x5620867fe6d8)) called at lib/OpenQA/WebAPI.pm line 185
        OpenQA::WebAPI::startup(OpenQA::WebAPI=HASH(0x562086540380)) called at /usr/share/perl5/Mojolicious.pm line 179
        Mojolicious::new(&quot;OpenQA::WebAPI&quot;) called at /usr/share/perl5/Mojo/Server.pm line 17
        Mojo::Server::build_app(Mojo::Server=HASH(0x56208650f6d0), &quot;OpenQA::WebAPI&quot;) called at /usr/share/perl5/Test/Mojo.pm line 247
        Test::Mojo::new(&quot;Test::Mojo&quot;, &quot;OpenQA::WebAPI&quot;) called at ./t/05-scheduler-dependencies.t line 212
</code></pre>

<pre><code>Can't locate t/ui/PhantomTest.pm in @INC (you may need to install the t::ui::PhantomTest module) (@INC contains: /build/openqa-4.3/t/ui lib /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.26.0 /usr/local/share/perl/5.26.0 /usr/lib/x86_64-linux-gnu/perl5/5.26 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.26 /usr/share/perl/5.26 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base) at ./t/ui/01-list.t line 37.
BEGIN failed--compilation aborted at ./t/ui/01-list.t line 37 (#1)
    (F) You said to do (or require, or use) a file that couldn't be found.
    Perl looks for the file in all the locations mentioned in @INC, unless
    the file name included the full path to the file.  Perhaps you need
    to set the PERL5LIB or PERL5OPT environment variable to say where the
    extra library is, or maybe the script needs to add the library name
    to @INC.  Or maybe you just misspelled the name of the file.  See
    &quot;require&quot; in perlfunc and lib.
</code></pre>

<pre><code>Uncaught exception from user code:
        Can't locate dbicdh/_common/deploy/_any/21-seeds.pl in @INC (@INC contains: /build/openqa-4.3/t lib /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.26.0 /usr/local/share/perl/5.26.0 /usr/lib/x86_64-linux-gnu/perl5/5.26 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.26 /usr/share/perl/5.26 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base) at (eval 1326) line 4.
         at /usr/share/perl5/Context/Preserve.pm line 42.
</code></pre>

<p>Mojolicious::Plugin::Bootstrap3 が必要そうだ。t::ui::PhantomTest と dbicdh/_common/deploy/_any/21-seeds.pl  はわからない。。。</p>

<p>&hellip;とここまで来たところで「upstreamもtestを実行していないので、とりあえず無視」ということにした。</p>

<ul>
<li>ビルド時には存在しないユーザーにchownしてる

<ul>
<li>ということはpostinstでchownするほうがいいか</li>
</ul></li>
<li>assetsディレクトリが存在しないので悩んでいたら、4.3の時点では存在せず、masterにはある&hellip;

<ul>
<li>コメントアウトしておく。</li>
</ul></li>
<li>存在しない systemd service ファイルのインストールが&hellip;

<ul>
<li>とりあえず消す</li>
</ul></li>
</ul>

<p>ということで4.3のビルドは一旦終わった。</p>

<hr />

<p>色々と試行錯誤してみたが、多分最新のupstreamだと上記のMojolicious::Plugin周りは解決してるんだろうと思う&hellip;ということで、masterをそのまま 4.3+20170928 としてビルド（9/28が最終コミットだったから）&hellip;うわ、これ Makefile の最初のところで <code>./script/generate-packed-assets</code> というのを実行して、どうやらネット越しにファイルを取ってくるようになってるぞ&hellip;厄介な&hellip;。</p>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/06/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Fri, Oct 6, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li>Updated <a href="http://www.debian.or.jp/using/mirror.html">mirror list on JP site</a></li>
</ul>

<hr />

<p>texliveの-docなパッケージがデカくて毎度のアップデートに時間取られるのが嫌だよねーという話から、色々と改善を模索してみる</p>

<ul>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=675869">PDFのバージョンを上げてサイズを落とす作戦</a>を深掘り。

<ul>
<li>1.4GBが1.0GBになるのは大きいと思う</li>
</ul></li>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=877771">-docパッケージがRecommendsになっていて引っ張られるのをSuggestsにしてインストールされないようにする作戦</a>

<ul>
<li>そもそもインストールされなければ気にしなくて済むよね、という話</li>
</ul></li>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=877862">texlive-fullを-docs-と-utilsに分けて、-docなパッケージをインストールしないようにする作戦</a>

<ul>
<li>わかんないから-fullを入れるのだけど、-docはいらないという人は多そうだから</li>
</ul></li>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=877770">-docパッケージがtexに依存してるのを確認する問題提起</a></li>
<li><a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=877769">逆に-docなパッケージ内でgzipでcompressされてるのはいいのか？という問題提起</a></li>
</ul>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/04/%E5%AE%9F%E9%A8%93%E5%AE%9F%E9%A8%93/">実験実験。</a></h3>
						<small><span class="label label-primary">
							
								Wed, Oct 4, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<p>go-apt-cacherによるキャッシュプロキシ実験、今度はもっと大きなパッケージ2つで試してみましょう。</p>

<pre><code>Package: texlive-latex-extra-doc
Download-Size: 384 MB

Package: texlive-pstricks-doc
Download-Size: 248 MB
</code></pre>

<p><code>time apt-get download texlive-latex-extra-doc texlive-pstricks-doc</code> という感じで取得。そして、さらに別のリージョンから試してみたらどうなるか？をやってみました。遠くのほうがいいかな、と西日本リージョンで仮想マシンを作成。そしてテストをしてみた。。。のですが、go-apt-cacherが <code>fatal error: runtime: out of memory</code> と<a href="https://github.com/cybozu-go/aptutil/issues/24">メモリ不足で落ちます</a>。VMをスケールアップして再度トライしました。</p>

<p>まずは普通にftp.jp.debian.orgからの取得。</p>

<pre><code>Fetched 412 MB in 36s (11.3 MB/s)
real    0m36.643s

Fetched 412 MB in 30s (13.4 MB/s)
real    0m30.864s

Fetched 412 MB in 26s (15.4 MB/s)
real    0m27.031s
</code></pre>

<p>次に西日本から取得。</p>

<pre><code>Fetched 412 MB in 19s (20.7 MB/s)
real    0m20.026s

Fetched 412 MB in 19s (21.1 MB/s)
real    0m19.688s

Fetched 412 MB in 18s (22.2 MB/s)
real    0m18.746s
</code></pre>

<p>東でやってみたら</p>

<pre><code>Fetched 412 MB in 24s (16.9 MB/s)
real    0m24.203s

Fetched 412 MB in 24s (17.2 MB/s)
real    0m24.598s
</code></pre>

<p>という感じでリージョンまたぐよりも逆に遅かった…何故だ。</p>

<hr />

<p>結論</p>

<pre><code>西日本： 21.3MBs
東日本： 17.0MBs
ダイレクト： 13.6 MBs
</code></pre>

<p>大体25-56%ぐらいの速度アップは望めるが、以前ほどでもない、という印象です。</p>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
            	
		
			<div class="row">
				
				<div class="col-md-offset-1 col-md-10">
					<h3><a href="https://henrich.github.io/blog/2017/10/03/%E3%82%81%E3%82%93%E3%81%A6%E3%81%AA%E3%81%AE%E3%81%8A%E3%81%97%E3%81%94%E3%81%A8/">めんてなのおしごと</a></h3>
						<small><span class="label label-primary">
							
								Tue, Oct 3, 2017
							</span>&nbsp;in
							 using tags
							
								
							<a href="/blog/tags/debian">debian</a>
						
					</small>
				</div>
			</div>
			<div class="row">
				<div class="col-md-offset-1 col-md-10">
					<br>
					
						<ul>
<li><a href="https://twitter.com/eldesh/status/915031977094389760">JPのページの誤りの指摘</a>を頂いたので修正した</li>
<li><a href="https://idcfcloud.com">IDCFクラウド</a>のDebianテンプレートで問題を見つけたのでチケットを切っておいた。</li>
</ul>

<hr />

<p>「VPSサービスに対して、高速なDebianミラーを提供したい」というのを思いつきました。ただ、あらゆるサービスでフルミラーを内部に置くのは難しいでしょうから、キャッシュプロキシを設置して対応するのはどうでしょう？</p>

<ul>
<li>思いついた対象候補

<ul>
<li>さくらのVPS</li>
<li>ConoHa</li>
<li><a href="https://www.idcf.jp/cloud/?cl=top_cloud">IDCFクラウド</a>(←ここではこれをチョイス)</li>
</ul></li>
</ul>

<p>IDCFクラウドは、<a href="https://www.idcf.jp/cloud/order.html?cl=cl_top#try">500円クーポン</a>があったのでこの範囲内で収めたいと思います（この後、さらに1000円クーポンを見つけたので今回の実験には十分ですね）。</p>

<ul>
<li>Debian8 と Ubuntu16.04 なテンプレートがあったので、こちらから仮想マシンを作ります（ファイアウォールの許可設定を忘れてSSHが通らなかった&hellip;）。</li>
<li>次に<a href="https://github.com/cybozu-go/aptutil/releases">go-apt-cacher</a>をダウンロードしてちょっと設定して起動します。</li>
<li>最後に/etc/apt/sources.listをいじってcache proxyを参照するようにします。2つのマシンは同じローカルセグメント内に居るので、apt lineのサーバー名はローカルIPを指定しました。</li>
</ul>

<pre><code># apt show openclipart-png
Package: openclipart-png
Source: openclipart
Version: 1:0.18+dfsg-14
Installed-Size: 148 MB
</code></pre>

<p>有意な差を確認したいので、そこそこの大きさのパッケージを見つけておきました。約150MBなら違いもでるでしょう。</p>

<pre><code># time apt-get download openclipart-png
Get:1 http://10.6.0.179:3142/debian/ jessie/main openclipart-png all 1:0.18+dfsg-14 [128 MB]
Fetched 128 MB in 10s (12.2 MB/s)          

real    0m10.742s
user    0m2.204s
sys 0m0.420s
</code></pre>

<p>まだキャッシュされていない状態からの取得は10.7秒（12.2MB/s）</p>

<pre><code># time apt-get download openclipart-png
Get:1 http://10.6.0.179:3142/debian/ jessie/main openclipart-png all 1:0.18+dfsg-14 [128 MB]
Fetched 128 MB in 2s (50.3 MB/s)           

real    0m2.758s
user    0m2.028s
sys 0m0.336s

# time apt-get download openclipart-png
Get:1 http://10.6.0.179:3142/debian/ jessie/main openclipart-png all 1:0.18+dfsg-14 [128 MB]
Fetched 128 MB in 2s (43.0 MB/s)          

real    0m3.423s
user    0m2.292s
sys 0m0.396s

# time apt-get download openclipart-png
Get:1 http://10.6.0.179:3142/debian/ jessie/main openclipart-png all 1:0.18+dfsg-14 [128 MB]
Fetched 128 MB in 3s (42.2 MB/s)           

real    0m3.237s
user    0m2.496s
sys 0m0.464s
</code></pre>

<p>キャッシュされた状態からだと平均で3.13秒（45.1MB/s）</p>

<p>ということで、12.2MB/s vs 45.1MB/s で3倍は速くなりそう、という雑な結論&hellip;ではありますが、IDCFクラウドで最も低スペックなマシン（light.S1、0.8GHz 1CPU/1GB Mem）で提供してもこの結果が出せたので、そこそこの大きさのVM作っておけば、めっちゃ多くのVMからのアクセスでもコンスタントに出せるようにはなるのでは？という推論。次は「同じサービスで他のネットワークにいるVMから同じことやったらどうなるか？」→これでスピードが出るなら、各サービスでgo-apt-cacher使うようにしたら、どうだろう？という提案になるかも。</p>

					
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<hr>
				</div>
			</div>
		
	

        
	</div>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="text-center">
                    

<ul class="pagination">
    
    <li>
        <a href="/blog/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
    </li>
    
    <li
    >
    <a href="/blog/page/6/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
    </li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/">1</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/page/2/">2</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/page/3/">3</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/page/6/">6</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    class="active"><a href="/blog/page/7/">7</a></li>
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/page/8/">8</a></li>
    
    
    
    
    
    
        
        
    
    
    <li class="disabled"><span aria-hidden="true">&hellip;</span></li>
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    
    
    
    
    
        
        
    
    
    <li
    ><a href="/blog/page/15/">15</a></li>
    
    
    <li
    >
    <a href="/blog/page/8/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
    </li>
    
    <li>
        <a href="/blog/page/15/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
    </li>
    
</ul>

                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <hr>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row col-md-12">
            <footer>
                <div class="pull-left">
                    <p>
                        &copy; 2015-  Hideki Yamane ~ Powered By <a href="http://hugo.spf13.com">Hugo</a> - version: 0.37.1 ~ <a href="https://henrich.github.io/blog//license">License</a>
                    </p>
                </div>

                
                <div class="pull-right">
                    
                    
                    
                        <a href="https://twitter.com/henrich" target="_blank">
                        <i class="fa fa-twitter-square fa-2x"></i></a>
                    
                    
                    
                    
                    
                        <a href="https://henrich.github.io/blog/index.xml" target="_blank">
                        <i class="fa fa-rss-square fa-2x"></i></a>
                    
                </div>
            </footer>
        </div>
    </div>

    
    </body>
</html>

