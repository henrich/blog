<!DOCTYPE html>
<html class="no-js" lang="en-us" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="めんてなのおしごと">
    <meta name="author" content="">

    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/favicon.ico">

    <title>めんてなのおしごと &middot; Forget me not...</title>

   	
    
        <link rel="stylesheet" href="https://henrich.github.io/blog//css/theme/simplex.css">
    

    <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/solid.js" integrity="sha384-F4BRNf3onawQt7LDHDJm/hwm3wBtbLIfGk1VSB/3nn3E+7Rox1YpYcKJMsmHBJIl" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/regular.js" integrity="sha384-V+AkgA1cZ+p3DRK63AHCaXvO68V7B5eHoxl7QVN21zftbkFn/sGAIVR7vmQL3Zhp" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/brands.js" integrity="sha384-VLgz+MgaFCnsFLiBwE3ItNouuqbWV2ZnIqfsA6QRHksEAQfgbcoaQ4PP0ZeS0zS5" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/fontawesome.js" integrity="sha384-treYPdjUrP4rW5q82SnECO7TPVAz4bpas16yuE9F5o7CeBn2YYw1yr5oC8s8Mf8t" crossorigin="anonymous"></script>

   	
   	<link rel="stylesheet" href="https://henrich.github.io/blog//css/style.css">


    
    <script src="https://henrich.github.io/blog//js/jquery.min-2.1.4.js"></script>
    <script src="https://henrich.github.io/blog//js/bootstrap.min-3.3.5.js"></script>

    
    <link href="" rel="alternate" type="application/rss+xml" title="Forget me not..." />
</head>
<body lang="en">
    
    <div class="container">
    <div class="row">
        <div class="navbar navbar-default navbar-inverse" role="navigation">
            <div class="navbar-header">
                <a class="navbar-brand" href="https://henrich.github.io/blog/">Forget me not...</a>
            </div>
            <div class="navbar-collapse collapse navbar-responsive-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://henrich.github.io/blog/">Home</a></li>
                    <li><a href="https://henrich.github.io/blog//post/">Blog</a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</div>



<div class="container">
	<div class="row">
		<div class="col-md-offset-1 col-md-10">
			<h3>めんてなのおしごと</h3>
				<span class="label label-primary">Wed, Apr 3, 2019</span> in
				
					
					<a href="/categories/debian">debian</a>
				
				
					
					<a href="/tags/debian">debian</a>
				
			</small>
		</div>
	</div>
	<div class="row">
		<div class="col-md-offset-1 col-md-10">
			<br>
			<p><code>itamae</code>のアップデートに<code>fluentd</code>が必要そうなのでこちらをやろうとしてみる。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gem2deb fluentd
fluentd doesn<span style="color:#e6db74">&#39;t seem to exist. Let&#39;</span>s try to download it with <span style="color:#e6db74">&#39;gem fetch fluentd&#39;</span>
gem fetch fluentd
Fetching: fluentd-1.4.2.gem <span style="color:#f92672">(</span>100%<span style="color:#f92672">)</span>
Downloaded fluentd-1.4.2
-- Creating source tarball from fluentd-1.4.2.gem ...
tar xfm /home/henrich/src/pkg-ruby-extras/fluentd-1.4.2.gem
<span style="color:#e6db74">&#34;tar xzfm data.tar.gz&#34;</span>
tar czf /home/henrich/src/pkg-ruby-extras/fluentd-1.4.2.tar.gz fluentd-1.4.2
-- Successfully created ./fluentd-1.4.2.tar.gz

-- Creating Debian source package from ./fluentd-1.4.2.tar.gz ...
tar xzf ruby-fluentd_1.4.2.orig.tar.gz
-- Generated Debian source tree in ruby-fluentd-1.4.2

-- Building Debian package ...
dpkg-buildpackage -us -uc
dpkg-buildpackage: info: source package ruby-fluentd
dpkg-buildpackage: info: source version 1.4.2-1
dpkg-buildpackage: info: source distribution UNRELEASED
dpkg-buildpackage: info: source changed by Hideki Yamane &lt;henrich@debian.org&gt;
dpkg-buildpackage: info: host architecture amd64
 dpkg-source --before-build .
dpkg-checkbuilddeps: error: Unmet build dependencies: ruby-cool.io <span style="color:#f92672">(</span><span style="color:#e6db74">&lt;&lt; 2.0.0) ruby-cool.io (&gt;= 1.4.5) ruby-dig-rb (&gt;= 1.0.0) ruby-http-parser.rb (&lt;&lt; 0.7.0) ruby-http-parser.rb (&gt;= 0.5.1) ruby-msgpack (&lt;&lt; 2</span>.0.0<span style="color:#f92672">)</span> ruby-msgpack <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 0.7.0<span style="color:#f92672">)</span> ruby-serverengine <span style="color:#f92672">(</span>&lt;&lt; 3.0.0<span style="color:#f92672">)</span> ruby-serverengine <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 2.0.4<span style="color:#f92672">)</span> ruby-sigdump <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 0.2.2<span style="color:#f92672">)</span> ruby-strptime <span style="color:#f92672">(</span><span style="color:#e6db74">&lt;&lt; 1.0.0) ruby-strptime (&gt;= 0.2.2) ruby-tzinfo (&gt;= 1</span>.0<span style="color:#f92672">)</span> ruby-tzinfo-data <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 1.0<span style="color:#f92672">)</span> ruby-yajl <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 1.0<span style="color:#f92672">)</span>
dpkg-buildpackage: warning: build dependencies/conflicts unsatisfied; aborting
</code></pre></div><p>依存関係が解決できなくてビルド失敗してる。<code>ruby-cool.io</code>パッケージが無いようなので、まずはこちらから作業。<code>gem2deb</code>でサクッと変換…と思いきや</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gem2deb cool.io
<span style="color:#f92672">(</span>snip<span style="color:#f92672">)</span>
dpkg-checkbuilddeps: error: Unmet build dependencies: ruby-rspec
dpkg-buildpackage: warning: build dependencies/conflicts unsatisfied; aborting
</code></pre></div><p>なぜにruby-rspecが無いとでる？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ apt show ruby-rspec
Package: ruby-rspec
Version: 3.8.0c0e1m0s0-1
Priority: optional
Section: ruby
</code></pre></div><p>あるよ？…もしかして、作業環境に入ってないから？いやー<code>cowbuilder</code>みたいにビルド環境で処理してよ…。とりあえず諸々作業…テストがコケたが、DNSを引きにいくものだったので無効にした。再度ビルド…</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">   dh_dwz -O--buildsystem<span style="color:#f92672">=</span>ruby
dwz: debian/ruby-cool.io/usr/lib/x86_64-linux-gnu/ruby/vendor_ruby/2.5.0/cool.io_ext.so: DWARF version <span style="color:#ae81ff">0</span> unhandled
dwz: debian/ruby-cool.io/usr/lib/x86_64-linux-gnu/ruby/vendor_ruby/2.5.0/iobuffer_ext.so: DWARF version <span style="color:#ae81ff">0</span> unhandled
dwz: Too few files <span style="color:#66d9ef">for</span> multifile optimization
objcopy: <span style="color:#e6db74">&#39;debian/ruby-cool.io/usr/lib/debug/.dwz/x86_64-linux-gnu/ruby-cool.io.debug&#39;</span>: No such file
dh_dwz: objcopy --compress-debug-sections debian/ruby-cool.io/usr/lib/debug/.dwz/x86_64-linux-gnu/ruby-cool.io.debug returned exit code <span style="color:#ae81ff">1</span>
make: *** <span style="color:#f92672">[</span>debian/rules:6: binary<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">2</span>
dpkg-buildpackage: error: debian/rules binary subprocess returned exit status <span style="color:#ae81ff">2</span>
</code></pre></div><p>どうも<code>debhelper level12</code>で出る問題なのだけど、<code>dh_dwz</code>って全く理解してないので一旦level11に落として回避…。あらかた出来たので<a href="https://salsa.debian.org/ruby-team/ruby-cool.io">リポジトリに追加</a>、<a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=926266">ITPバグも登録</a>してアップロードした（この間にupstreamのバージョンが1.5.3から1.5.4に上がってギョッとした）。<code>NEW queue</code>通るのはずっと先だろうな…。</p>
<hr>
<p>次は<code>ruby-dig-rb</code>パッケージ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gem2deb dig-rb  
dig-rb doesn<span style="color:#e6db74">&#39;t seem to exist. Let&#39;</span>s try to download it with <span style="color:#e6db74">&#39;gem fetch dig-rb&#39;</span>
gem fetch dig-rb
ERROR:  Could not find a valid gem <span style="color:#e6db74">&#39;dig-rb&#39;</span> <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 0<span style="color:#f92672">)</span> in any repository
ERROR:  Possible alternatives: dig_rb  
Failed to download .gem file
</code></pre></div><p>gemが見つからない？とおもったら「dig_rb」と<code>_</code>使ってるでやんの…指定し直し。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gem2deb dig_rb  
dig_rb doesn<span style="color:#e6db74">&#39;t seem to exist. Let&#39;</span>s try to download it with <span style="color:#e6db74">&#39;gem fetch dig_rb&#39;</span>
gem fetch dig_rb
Fetching: dig_rb-1.0.1.gem <span style="color:#f92672">(</span>100%<span style="color:#f92672">)</span>
Downloaded dig_rb-1.0.1
<span style="color:#f92672">(</span>snip<span style="color:#f92672">)</span>
-- Debian package successfully built!
</code></pre></div><p>素晴らしい、無事変換できた。</p>
<hr>
<p>次に無いのは<code>ruby-serverengine</code>パッケージ。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pbuilder-satisfydepends-dummy : Depends: ruby-sigdump <span style="color:#f92672">(</span>&gt;<span style="color:#f92672">=</span> 0.2.2<span style="color:#f92672">)</span> which is a virtual package and is not provided by any available package
</code></pre></div><p><code>gem2deb sigdump</code>で対応、basecowに入れておく。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cp -arp /var/cache/pbuilder/base.cow /var/cache/pbuilder/ruby.cow
$ sudo cp ruby-sigdump_0.2.4-1_all.deb /var/cache/pbuilder/ruby.cow/tmp
$ sudo cowbuilder --login --basepath /var/cache/pbuilder/ruby.cow --save-after-exec
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># apt install /tmp/ruby-sigdump_0.2.4-1_all.deb</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo cowbuilder --build --basepath /var/cache/pbuilder/ruby.cow/ ruby-serverengine_2.1.0-1.dsc
</code></pre></div><p>で、パッケージバージョンでエラーになったのでこんなふうにしてみた。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">--- a/serverengine.gemspec
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/serverengine.gemspec
</span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -21,8 +21,8 @@
</span><span style="color:#75715e"></span>   gem.add_dependency &#34;sigdump&#34;, [&#34;~&gt; 0.2.2&#34;]

   # rake v12.x doesn&#39;t work with rspec 2. rspec should be updated to 3
<span style="color:#f92672">-  gem.add_development_dependency &#34;rake&#34;, [&#34;~&gt; 11.0&#34;]
</span><span style="color:#f92672">-  gem.add_development_dependency &#34;rspec&#34;, [&#34;~&gt; 2.13.0&#34;]
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+  gem.add_development_dependency &#34;rake&#34;
</span><span style="color:#a6e22e">+  gem.add_development_dependency &#34;rspec&#34;
</span><span style="color:#a6e22e"></span>
   gem.add_development_dependency &#39;rake-compiler-dock&#39;, [&#39;~&gt; 0.5.0&#39;]
   gem.add_development_dependency &#39;rake-compiler&#39;, [&#39;~&gt; 0.9.4&#39;]
</code></pre></div><p>でもやっぱりエラー。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Could not find gem <span style="color:#e6db74">&#39;rake-compiler-dock (~&gt; 0.5.0)&#39;</span> in any of the gem sources listed in your Gemfile.
</code></pre></div><p>あー。ないね。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ gem2deb rake-compiler-dock
<span style="color:#f92672">(</span>snip<span style="color:#f92672">)</span>
<span style="color:#ae81ff">7</span> tests, <span style="color:#ae81ff">21</span> assertions, <span style="color:#ae81ff">5</span> failures, <span style="color:#ae81ff">0</span> errors, <span style="color:#ae81ff">0</span> pendings, <span style="color:#ae81ff">0</span> omissions, <span style="color:#ae81ff">0</span> notifications
28.5714% passed
</code></pre></div><p>エラーログを見る。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rake" data-lang="rake"><span style="color:#e6db74">TestEnvironmentVariables</span>:
  <span style="color:#e6db74">test_HOST_RUBY_PLATFORM</span>:  <span style="color:#66d9ef">Docker</span> is <span style="color:#f92672">not</span> available<span style="color:#f92672">.</span>
</code></pre></div><p>これは難儀そう…とdebian/controlを眺めると「Easy to use and reliable cross compiler environment for building Windows and Linux binary gems.」との説明文。ということはこれ、要らないのでは？外す。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Could not find gem <span style="color:#e6db74">&#39;rake-compiler (~&gt; 0.9.4)&#39;</span> in any of the gem sources listed in your Gemfile.
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Package: rake-compiler
Version: 1.0.5-1
</code></pre></div><p>なんだよもー。これもバージョン外してやってみよう。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/usr/bin/ruby2.5 /usr/bin/rspec --pattern ./spec/<span style="color:#ae81ff">\*\*</span>/<span style="color:#ae81ff">\*</span>_spec.rb --format documentation failed
ERROR: Test <span style="color:#e6db74">&#34;ruby2.5&#34;</span> failed. Exiting.
dh_auto_install: dh_ruby --install /build/ruby-serverengine-2.1.0/debian/ruby-serverengine returned exit code <span style="color:#ae81ff">1</span>
make: *** <span style="color:#f92672">[</span>debian/rules:6: binary<span style="color:#f92672">]</span> Error <span style="color:#ae81ff">1</span>
</code></pre></div><p>うーん、どこかのテストがエラーになるな。1個ずつやってみよう。。。。あれ、エラー吐いてるのにテストが問題ないとなるのもあるね…。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ServerEngine::Supervisor
  initialize error
  when :log<span style="color:#f92672">=</span>IO option is given
I, <span style="color:#f92672">[</span>2019-04-03T14:37:32.253000 <span style="color:#75715e">#27406]  INFO -- : Received graceful stop</span>
    can start
  when :logger option is given
I, <span style="color:#f92672">[</span>2019-04-03T14:37:33.055374 <span style="color:#75715e">#27406]  INFO -- : Received graceful stop</span>
    uses specified logger instance
  when both :logger and :log options are given
I, <span style="color:#f92672">[</span>2019-04-03T14:37:33.857608 <span style="color:#75715e">#27406]  INFO -- : Received graceful stop</span>
    start ignoring :log
  when using signal as command_sender
I, <span style="color:#f92672">[</span>2019-04-03T14:37:34.664887 <span style="color:#75715e">#27574]  INFO -- : Received graceful stop</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:34.862993 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 0</span>
    start and graceful stop
I, <span style="color:#f92672">[</span>2019-04-03T14:37:35.671015 <span style="color:#75715e">#27594]  INFO -- : Received immediate stop</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:35.870587 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 0</span>
    immediate stop
I, <span style="color:#f92672">[</span>2019-04-03T14:37:36.678895 <span style="color:#75715e">#27615]  INFO -- : Received graceful restart</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:37.477583 <span style="color:#75715e">#27615]  INFO -- : Received graceful stop</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:37.879210 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 0</span>
    graceful restart
I, <span style="color:#f92672">[</span>2019-04-03T14:37:38.686002 <span style="color:#75715e">#27654]  INFO -- : Received immediate restart</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:39.489342 <span style="color:#75715e">#27654]  INFO -- : Received graceful stop</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:39.886976 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 0</span>
    immediate restart
I, <span style="color:#f92672">[</span>2019-04-03T14:37:40.691983 <span style="color:#75715e">#27688]  INFO -- : Received reload</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:40.692981 <span style="color:#75715e">#27688]  INFO -- : Received graceful stop</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:40.892738 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 0</span>
    reload
Unexpected error error test
  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in <span style="color:#e6db74">`</span>block in start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in `block in fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in <span style="color:#e6db74">`</span>start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:195:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in <span style="color:#e6db74">`</span>block in start_supervisor<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">I, [2019-04-03T14:37:41.398888 #27406]  INFO -- : Server finished unexpectedly with status 1
</span><span style="color:#e6db74">Unexpected error error test
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in `block in start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in <span style="color:#e6db74">`</span>block in fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in `start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:307:in <span style="color:#e6db74">`</span>reboot_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:208:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in <span style="color:#e6db74">`</span>block in start_supervisor<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">I, [2019-04-03T14:37:42.401104 #27406]  INFO -- : Server finished unexpectedly with status 1
</span><span style="color:#e6db74">Unexpected error error test
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in `block in start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in <span style="color:#e6db74">`</span>block in fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in `start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:307:in <span style="color:#e6db74">`</span>reboot_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:208:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in <span style="color:#e6db74">`</span>block in start_supervisor<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">I, [2019-04-03T14:37:43.400219 #27406]  INFO -- : Server finished with status 1
</span><span style="color:#e6db74">    auto restart in limited ratio
</span><span style="color:#e6db74">  when using pipe as command_sender
</span><span style="color:#e6db74">I, [2019-04-03T14:37:44.204850 #27757]  INFO -- : Received graceful stop
</span><span style="color:#e6db74">#&lt;Thread:0x000055ddba860f40@/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:81 run&gt; terminated with exception (report_on_exception is true):
</span><span style="color:#e6db74">/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:83:in `block in install_signal_handlers&#39;</span>: undefined method <span style="color:#e6db74">`</span>chomp<span style="color:#e6db74">&#39; for nil:NilClass (NoMethodError)
</span><span style="color:#e6db74">I, [2019-04-03T14:37:44.408173 #27406]  INFO -- : Server finished with status 0
</span><span style="color:#e6db74">    start and graceful stop
</span><span style="color:#e6db74">I, [2019-04-03T14:37:45.215304 #27780]  INFO -- : Received immediate stop
</span><span style="color:#e6db74">#&lt;Thread:0x000055ddba97e760@/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:81 run&gt; terminated with exception (report_on_exception is true):
</span><span style="color:#e6db74">/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:83:in `block in install_signal_handlers&#39;</span>: undefined method <span style="color:#e6db74">`</span>chomp<span style="color:#e6db74">&#39; for nil:NilClass (NoMethodError)
</span><span style="color:#e6db74">    immediate stop
</span><span style="color:#e6db74">I, [2019-04-03T14:37:45.414819 #27406]  INFO -- : Server finished with status 0
</span><span style="color:#e6db74">I, [2019-04-03T14:37:46.220865 #27799]  INFO -- : Received graceful restart
</span><span style="color:#e6db74">I, [2019-04-03T14:37:47.024452 #27799]  INFO -- : Received graceful stop
</span><span style="color:#e6db74">#&lt;Thread:0x000055ddba9fa6f8@/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:81 run&gt; terminated with exception (report_on_exception is true):
</span><span style="color:#e6db74">/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:83:in `block in install_signal_handlers&#39;</span>: undefined method <span style="color:#e6db74">`</span>chomp<span style="color:#e6db74">&#39; for nil:NilClass (NoMethodError)
</span><span style="color:#e6db74">I, [2019-04-03T14:37:47.421282 #27406]  INFO -- : Server finished with status 0
</span><span style="color:#e6db74">    graceful restart
</span><span style="color:#e6db74">I, [2019-04-03T14:37:48.227456 #27837]  INFO -- : Received immediate restart
</span><span style="color:#e6db74">I, [2019-04-03T14:37:49.029153 #27837]  INFO -- : Received graceful stop
</span><span style="color:#e6db74">#&lt;Thread:0x000055ddbaaa8af0@/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:81 run&gt; terminated with exception (report_on_exception is true):
</span><span style="color:#e6db74">/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:83:in `block in install_signal_handlers&#39;</span>: undefined method <span style="color:#e6db74">`</span>chomp<span style="color:#e6db74">&#39; for nil:NilClass (NoMethodError)
</span><span style="color:#e6db74">I, [2019-04-03T14:37:49.429525 #27406]  INFO -- : Server finished with status 0
</span><span style="color:#e6db74">    immediate restart
</span><span style="color:#e6db74">I, [2019-04-03T14:37:50.238952 #27872]  INFO -- : Received reload
</span><span style="color:#e6db74">I, [2019-04-03T14:37:50.240958 #27872]  INFO -- : Received graceful stop
</span><span style="color:#e6db74">#&lt;Thread:0x000055ddba9cc2a8@/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:81 run&gt; terminated with exception (report_on_exception is true):
</span><span style="color:#e6db74">/build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:83:in `block in install_signal_handlers&#39;</span>: undefined method <span style="color:#e6db74">`</span>chomp<span style="color:#e6db74">&#39; for nil:NilClass (NoMethodError)
</span><span style="color:#e6db74">I, [2019-04-03T14:37:50.439080 #27406]  INFO -- : Server finished with status 0
</span><span style="color:#e6db74">    reload
</span><span style="color:#e6db74">Unexpected error error test
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in `run&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in `block in start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in <span style="color:#e6db74">`</span>block in fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in `start_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:195:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in `block in start_supervisor&#39;</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:50.943666 <span style="color:#75715e">#27406]  INFO -- : Server finished unexpectedly with status 1</span>
Unexpected error error test
  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in <span style="color:#e6db74">`</span>block in start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in `block in fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in <span style="color:#e6db74">`</span>start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:307:in `reboot_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:208:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in `block in start_supervisor&#39;</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:51.944788 <span style="color:#75715e">#27406]  INFO -- : Server finished unexpectedly with status 1</span>
Unexpected error error test
  /build/ruby-serverengine-2.1.0/spec/server_worker_context.rb:223:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/worker.rb:81:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/embedded_server.rb:26:in <span style="color:#e6db74">`</span>run<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/server.rb:128:in `main&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:269:in <span style="color:#e6db74">`</span>block in start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:134:in `block in fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in <span style="color:#e6db74">`</span>fork<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/process_manager.rb:126:in `fork&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:260:in <span style="color:#e6db74">`</span>start_server<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:307:in `reboot_server&#39;</span>
  /build/ruby-serverengine-2.1.0/lib/serverengine/supervisor.rb:208:in <span style="color:#e6db74">`</span>main<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">  /build/ruby-serverengine-2.1.0/spec/supervisor_spec.rb:10:in `block in start_supervisor&#39;</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:37:52.946855 <span style="color:#75715e">#27406]  INFO -- : Server finished with status 1</span>
    auto restart in limited ratio


<span style="color:#ae81ff">1</span> deprecation warning total
Deprecation Warnings:

Finished in 24.13 seconds <span style="color:#f92672">(</span>files took 0.26415 seconds to load<span style="color:#f92672">)</span>
<span style="color:#ae81ff">28</span> examples, <span style="color:#ae81ff">0</span> failures
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ServerEngine::MultiThreadServer
I, <span style="color:#f92672">[</span>2019-04-03T14:44:36.057152 <span style="color:#75715e">#3330]  INFO -- : Received reload</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:44:37.558054 <span style="color:#75715e">#3330]  INFO -- : Received graceful stop</span>
  scale up
I, <span style="color:#f92672">[</span>2019-04-03T14:44:38.560735 <span style="color:#75715e">#3330]  INFO -- : Received graceful restart</span>
I, <span style="color:#f92672">[</span>2019-04-03T14:44:40.061600 <span style="color:#75715e">#3330]  INFO -- : Received graceful stop</span>
  scale down
/usr/bin/ruby2.5 /usr/bin/rspec --pattern ./spec/<span style="color:#ae81ff">\*\*</span>/multi_process<span style="color:#ae81ff">\*</span>_spec.rb --format documentation failed
ERROR: Test <span style="color:#e6db74">&#34;ruby2.5&#34;</span> failed. Exiting.
</code></pre></div><p><code>spec/multi_process_server_spec.rb</code>がコケてる</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    it <span style="color:#e6db74">&#39;raises SystemExit when all workers exit with specified code by unrecoverable_exit_codes&#39;</span> <span style="color:#66d9ef">do</span>
      pending <span style="color:#e6db74">&#34;unrecoverable_exit_codes supported only for multi process workers&#34;</span> <span style="color:#66d9ef">if</span> impl_class <span style="color:#f92672">==</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MultiThreadServer</span>
      pending <span style="color:#e6db74">&#34;Windows environment does not support fork&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">.</span>windows? <span style="color:#f92672">&amp;&amp;</span> impl_class <span style="color:#f92672">==</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MultiProcessServer</span>

      config <span style="color:#f92672">=</span> {<span style="color:#e6db74">workers</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">log_stdout</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">log_stderr</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">unrecoverable_exit_codes</span>: <span style="color:#f92672">[</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">]</span>}

      s <span style="color:#f92672">=</span> impl_class<span style="color:#f92672">.</span>new(<span style="color:#66d9ef">TestExitWorker</span>) { config<span style="color:#f92672">.</span>dup }
      raised_error <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
      t <span style="color:#f92672">=</span> <span style="color:#66d9ef">Thread</span><span style="color:#f92672">.</span>new <span style="color:#66d9ef">do</span>
        <span style="color:#66d9ef">begin</span>
          s<span style="color:#f92672">.</span>main
        <span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">SystemExit</span> <span style="color:#f92672">=&gt;</span> e
          raised_error <span style="color:#f92672">=</span> e
        <span style="color:#66d9ef">end</span>
      <span style="color:#66d9ef">end</span>

      wait_for_fork
      test_state(<span style="color:#e6db74">:worker_run</span>)<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>
      t<span style="color:#f92672">.</span>join

      test_state(<span style="color:#e6db74">:worker_stop</span>)<span style="color:#f92672">.</span>to_i<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>
      raised_error<span style="color:#f92672">.</span>status<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 4th process&#39;s exit status</span>
    <span style="color:#66d9ef">end</span>

    it <span style="color:#e6db74">&#39;raises SystemExit immediately when a worker exits if stop_immediately_at_unrecoverable_exit specified&#39;</span> <span style="color:#66d9ef">do</span>
      pending <span style="color:#e6db74">&#34;unrecoverable_exit_codes supported only for multi process workers&#34;</span> <span style="color:#66d9ef">if</span> impl_class <span style="color:#f92672">==</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MultiThreadServer</span>
      pending <span style="color:#e6db74">&#34;Windows environment does not support fork&#34;</span> <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">.</span>windows? <span style="color:#f92672">&amp;&amp;</span> impl_class <span style="color:#f92672">==</span> <span style="color:#66d9ef">ServerEngine</span><span style="color:#f92672">::</span><span style="color:#66d9ef">MultiProcessServer</span>

      config <span style="color:#f92672">=</span> {<span style="color:#e6db74">workers</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">log_stdout</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">log_stderr</span>: <span style="color:#66d9ef">false</span>, <span style="color:#e6db74">unrecoverable_exit_codes</span>: <span style="color:#f92672">[</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">stop_immediately_at_unrecoverable_exit</span>: <span style="color:#66d9ef">true</span>}

      s <span style="color:#f92672">=</span> impl_class<span style="color:#f92672">.</span>new(<span style="color:#66d9ef">TestExitWorker</span>) { config<span style="color:#f92672">.</span>dup }
      raised_error <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
      t <span style="color:#f92672">=</span> <span style="color:#66d9ef">Thread</span><span style="color:#f92672">.</span>new <span style="color:#66d9ef">do</span>
        <span style="color:#66d9ef">begin</span>
          s<span style="color:#f92672">.</span>main
        <span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">SystemExit</span> <span style="color:#f92672">=&gt;</span> e
          raised_error <span style="color:#f92672">=</span> e
        <span style="color:#66d9ef">end</span>
      <span style="color:#66d9ef">end</span>

      wait_for_fork
      test_state(<span style="color:#e6db74">:worker_run</span>)<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>
      t<span style="color:#f92672">.</span>join

      test_state(<span style="color:#e6db74">:worker_stop</span>)<span style="color:#f92672">.</span>to_i<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>
      test_state(<span style="color:#e6db74">:worker_finished</span>)<span style="color:#f92672">.</span>to_i<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>
      raised_error<span style="color:#f92672">.</span>should_not be_nil
      raised_error<span style="color:#f92672">.</span>status<span style="color:#f92672">.</span>should <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span> <span style="color:#75715e"># 1st process&#39;s exit status</span>
    <span style="color:#66d9ef">end</span>
</code></pre></div><p>うーん。とりあえず該当のテストを無効にしておくか。</p>

		</div>
	</div>
	<div class="row">
		<div class="col-md-12">
			<hr>
		</div>
	</div>
</div>

    <div class="container">
        <div class="row col-md-12">
            <footer>
                <div class="pull-left">
                    <p>
                        &copy;  ~ Powered By <a href="https://gohugo.io/">Hugo</a> - version: 0.69.2 ~ <a href="https://henrich.github.io/blog//license">License</a>
                    </p>
                </div>

                
                <div class="pull-right">
                    
                    
                    
                    
                    
                    
                    
                    
                </div>
            </footer>
        </div>
    </div>

    
    </body>
</html>

